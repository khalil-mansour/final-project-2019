image: docker:18.09.7

variables:
  DOCKER_DRIVER: overlay

services:
  - docker:18.09.7-dind

stages:
  - build
  - test 
  - deploy

build:
  stage: build
  script:
    - echo $GCLOUD_SERVICE_KEY > ${HOME}/gcloud-service-key.json
    - sudo docker login -u _json_key --password-stdin https://gcr.io < ${HOME}/gcloud-service-key.json
    - echo "building docker image"
    - sudo docker build -t gcr.io/$GCLOUD_PROJECT_ID/$IMAGE_NAME .

test:
  stage: test
  script: 
    - echo "Running tests"

deploy_staging:
  stage: deploy
  before_script:
    - echo "pushing docker image"
    - sudo docker push "gcr.io/$GCLOUD_PROJECT_ID/$IMAGE_NAME"
  image: google/cloud-sdk:latest
  script:
    - echo "deploying..."
  environment:
    name: staging
  when: manual
  only:
    - master
